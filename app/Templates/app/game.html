{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>ğŸ· Heo Con Ä‚n TrÃ¡i CÃ¢y ğŸ</title>
  <style>
    :root{--bg:#bdf;--canvas-bg:#e6fff2}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);display:flex;align-items:center;justify-content:center}
    .wrap{display:flex;gap:20px;align-items:flex-start}
    canvas{background:var(--canvas-bg);border:3px solid #fff;border-radius:16px;box-shadow:0 0 20px rgba(0,0,0,0.15);display:block}
    .ui{width:220px}
    .panel{background:#fff;padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .panel h3{margin:0 0 8px;font-size:18px;color:#074}
    .score{font-size:20px;color:#053;margin-bottom:8px}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:0;background:#0d6efd;color:#fff;cursor:pointer;margin-right:6px}
    .btn.secondary{background:#6c757d}
    .controls{margin-top:10px;display:flex;gap:6px;flex-wrap:wrap}
    .note{font-size:12px;color:#666;margin-top:8px}
    @media(max-width:900px){.wrap{flex-direction:column;align-items:center}.ui{width:90%}}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="800" height="500"></canvas>

    <div class="ui">
      <div class="panel">
        <h3>ğŸ· Heo Con Ä‚n TrÃ¡i CÃ¢y</h3>
        <div class="score" id="scoreLabel">Äiá»ƒm: 0</div>
        <div>Thá»i gian: <span id="timeLabel">0</span>s</div>
        <div class="controls">
          <button id="btnPause" class="btn">Táº¡m dá»«ng</button>
          <button id="btnRestart" class="btn secondary">ChÆ¡i láº¡i</button>
        </div>
        <div class="note">PhÃ­m: â† â†’ hoáº·c A D Ä‘á»ƒ di chuyá»ƒn. Giá»¯ phÃ­m Ä‘á»ƒ di chuyá»ƒn liÃªn tá»¥c.</div>
        <hr>
        <div class="note">Náº¿u Ã¢m thanh khÃ´ng phÃ¡t trÃªn trÃ¬nh duyá»‡t, nháº¥n báº¥t ká»³ phÃ­m nÃ o trÆ°á»›c Ä‘á»ƒ kÃ­ch hoáº¡t.</div>
      </div>
    </div>
  </div>

  <script>
    // canvas + ctx
    const c = document.getElementById("game");
    const ctx = c.getContext("2d");

    // game state
    const WIDTH = c.width, HEIGHT = c.height;
    let pig = { x: WIDTH/2, y: HEIGHT - 40, w: 80, h: 50, speed: 6 };
    let items = [], score = 0, ticks = 0, elapsed = 0;
    let running = true;
    let lastTime = performance.now();

    // assets
    const pigImg = new Image();
    const fruitImg = new Image();
    const poopImg = new Image();
    pigImg.src = "{% static 'app/pig.png' %}";
    fruitImg.src = "{% static 'app/fruit.png' %}";
    poopImg.src = "{% static 'app/poop.png' %}";

    const eatSound = new Audio("{% static 'app/eat.wav' %}");
    const poopSound = new Audio("{% static 'app/poop.wav' %}");
    // prepare sounds to avoid promise errors; browsers require user gesture to play audio
    [eatSound, poopSound].forEach(s => { s.preload = "auto"; s.load(); });

    // controls (continuous)
    const keys = { left:false, right:false };
    document.addEventListener("keydown", e => {
      if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") keys.left = true;
      if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") keys.right = true;
      // user gesture to allow audio play on some browsers
      if (eatSound.paused) {
        eatSound.muted = false;
        poopSound.muted = false;
      }
    });
    document.addEventListener("keyup", e => {
      if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") keys.left = false;
      if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") keys.right = false;
    });

    // touch controls for mobile
    c.addEventListener("touchstart", e => {
      const t = e.touches[0];
      if (t.clientX < window.innerWidth/2) keys.left = true;
      else keys.right = true;
    });
    c.addEventListener("touchend", e => { keys.left = keys.right = false; });

    // spawn item
    function spawn() {
      const kind = Math.random() < 0.8 ? "fruit" : "poop";
      const margin = 30;
      const x = Math.random() * (WIDTH - margin*2) + margin;
      const vy = Math.random() * 1.5 + 2.0 + Math.min(2.5, elapsed/30); // speed increases over time
      items.push({ x, y: -30, vy, t: kind, size: 40 });
    }

    // play sound safely
    function playSound(s) {
      try {
        s.currentTime = 0;
        s.play();
      } catch (err) {
        // ignore (most likely user gesture policy)
      }
    }

    // collision check (circle-vs-rect approx)
    function checkCollision(item) {
      // treat item as circle radius r and pig as rect
      const r = item.size/2;
      const cx = item.x, cy = item.y;
      const rx = pig.x - pig.w/2, ry = pig.y - pig.h/2, rw = pig.w, rh = pig.h;
      // closest point on rect to circle center
      const closestX = Math.max(rx, Math.min(cx, rx + rw));
      const closestY = Math.max(ry, Math.min(cy, ry + rh));
      const dx = cx - closestX;
      const dy = cy - closestY;
      return (dx*dx + dy*dy) <= (r*r);
    }

    // update + draw
    function update(dt) {
      ticks += dt;
      elapsed += dt/1000;

      // spawn every ~0.8s (decreases with time)
      if (ticks > Math.max(400, 800 - elapsed*10)) {
        spawn();
        ticks = 0;
      }

      // move pig
      if (keys.left) pig.x -= pig.speed;
      if (keys.right) pig.x += pig.speed;
      // clamp pig with half-width
      pig.x = Math.max(pig.w/2, Math.min(WIDTH - pig.w/2, pig.x));

      // update items
      for (let it of items) {
        it.y += it.vy;
      }

      // collisions and remove off-screen
      for (let i = items.length - 1; i >= 0; i--) {
        const it = items[i];
        if (it.y > HEIGHT + 40) { items.splice(i,1); continue; }
        if (checkCollision(it)) {
          if (it.t === "fruit") { score += 1; playSound(eatSound); }
          else { score = Math.max(0, score - 2); playSound(poopSound); }
          items.splice(i,1);
        }
      }
    }

    function draw() {
      // background
      ctx.clearRect(0,0,WIDTH,HEIGHT);
      ctx.fillStyle = "#dfffef";
      ctx.fillRect(0,0,WIDTH,HEIGHT);

      // draw pig
      const px = pig.x - pig.w/2, py = pig.y - pig.h/2;
      if (pigImg.complete) ctx.drawImage(pigImg, px, py, pig.w, pig.h);
      else {
        // fallback simple pig
        ctx.fillStyle = "pink";
        ctx.fillRect(px, py, pig.w, pig.h);
      }

      // draw items
      for (let it of items) {
        const drawX = it.x - it.size/2, drawY = it.y - it.size/2;
        if (it.t === "fruit") {
          if (fruitImg.complete) ctx.drawImage(fruitImg, drawX, drawY, it.size, it.size);
          else { ctx.fillStyle="orange"; ctx.beginPath(); ctx.arc(it.x,it.y,it.size/2,0,Math.PI*2); ctx.fill(); }
        } else {
          if (poopImg.complete) ctx.drawImage(poopImg, drawX, drawY, it.size, it.size);
          else { ctx.fillStyle="#6b3"; ctx.fillRect(drawX,drawY,it.size,it.size); }
        }
      }

      // UI
      ctx.fillStyle = "#053";
      ctx.font = "20px Arial";
      ctx.fillText("Äiá»ƒm: " + score, 12, 28);
      ctx.font = "14px Arial";
      ctx.fillText("Thá»i gian: " + Math.floor(elapsed) + "s", 12, 48);

      // draw ground line
      ctx.strokeStyle = "rgba(0,0,0,0.05)";
      ctx.beginPath(); ctx.moveTo(0, pig.y + pig.h/2 + 6); ctx.lineTo(WIDTH, pig.y + pig.h/2 + 6); ctx.stroke();
    }

    // main loop
    function loop(now) {
      if (!running) { lastTime = now; requestAnimationFrame(loop); return; }
      const dt = now - lastTime;
      lastTime = now;
      update(dt);
      draw();
      requestAnimationFrame(loop);
    }

    // start
    requestAnimationFrame(loop);

    // UI buttons
    document.getElementById("btnPause").addEventListener("click", () => {
      running = !running;
      document.getElementById("btnPause").textContent = running ? "Táº¡m dá»«ng" : "Tiáº¿p tá»¥c";
    });
    document.getElementById("btnRestart").addEventListener("click", () => {
      // reset state
      items = []; score = 0; elapsed = 0; ticks = 0; running = true; pig.x = WIDTH/2;
      document.getElementById("btnPause").textContent = "Táº¡m dá»«ng";
    });

    // expose score/time to outside (optional)
    window.getGameState = () => ({ score, seconds: Math.floor(elapsed) });
  pigImg.src = "{% static 'app/pig.png' %}";
  fruitImg.src = "{% static 'app/fruit.png' %}";
  poopImg.src = "{% static 'app/poop.png' %}";

  </script>
</body>
</html>

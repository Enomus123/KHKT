<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>D·ª± √°n khoa h·ªçc k·ªπ thu·∫≠t</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      .navbar-nav .nav-link { font-weight: 500; transition: 0.3s; }
      .navbar-nav .nav-link:hover { color: #0d6efd !important; }
      footer { background:#f8f9fa; padding:20px 0; text-align:center; }

      #chatbot-box {
          position: fixed;
          bottom: 20px;
          right: 20px;
          width: 340px;
          max-height: 70vh;
          background: white;
          border-radius: 15px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          display: none;
          flex-direction: column;
          overflow: hidden;
          z-index: 9999;
      }

      #chatbot-header {
          background: #0d6efd;
          color: white;
          padding: 12px;
          text-align: center;
          font-weight: bold;
          font-size: 17px;
          position: relative;
      }

      #chatbot-header span {
          position: absolute;
          right: 12px;
          top: 8px;
          cursor: pointer;
          font-size: 20px;
      }

      #chatbot-messages {
          padding: 12px;
          height: 300px;
          overflow-y: auto;
          font-size: 15px;
      }

      #chatbot-input-area {
          padding: 10px;
          display: flex;
          gap: 8px;
          border-top: 1px solid #ddd;
      }

      #chatbot-text {
          flex: 1;
          padding: 8px;
          border-radius: 10px;
          border: 1px solid #ccc;
      }

      #chatbot-send {
          width: 70px;
          border: none;
          background: #0d6efd;
          color: white;
          border-radius: 10px;
      }

      #chat-toggle-btn {
          position: fixed;
          bottom: 25px;
          right: 25px;
          background: #0d6efd;
          color: white;
          width: 55px;
          height: 55px;
          display: flex;
          justify-content: center;
          align-items: center;
          border-radius: 50%;
          font-size: 26px;
          cursor: pointer;
          box-shadow: 0 3px 10px rgba(0,0,0,0.25);
          z-index: 9999;
      }

      #chat-toggle-btn.hide { display: none; }

      @media (max-width: 600px) {
          #chatbot-box { width: 95%; right: 2.5%; bottom: 10px; max-height: 80vh; }
          #chatbot-messages { height: 55vh; font-size: 16px; }
      }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold text-primary" href="#">KHKT</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav align-items-center">

        <!-- Khi ƒë√£ ƒëƒÉng nh·∫≠p -->
        <li class="nav-item" style="visibility: {{user_login}}">
          <div class="user-section">
            <span class="fw-semibold text-success">üëã Xin ch√†o, {{request.user}}</span>
            <a class="btn btn-sm btn-outline-danger" href="{% url 'logout' %}">ƒêƒÉng xu·∫•t</a>
          </div>
        </li>

        <!-- Khi ch∆∞a ƒëƒÉng nh·∫≠p -->
        <li class="nav-item" style="visibility: {{user_not_login}}">
          <div class="user-section">
            <a class="btn btn-sm btn-login" href="{% url 'login' %}">ƒêƒÉng nh·∫≠p</a>
            <a class="btn btn-sm btn-register" href="{% url 'register' %}">ƒêƒÉng k√Ω</a>
          </div>
        </li>

      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
    {% block content %}{% endblock %}
</div>

<footer>
    ¬© 2025 KHKT - Website th·ª≠ nghi·ªám AI Chatbot
</footer>

<!-- Toggle button -->
<div id="chat-toggle-btn">üí¨</div>

<!-- Chatbot UI -->
<div id="chatbot-box">
    <div id="chatbot-header">Ng∆∞·ªùi b·∫°n ·∫£o <span id="chat-close">‚úñ</span></div>
    <div id="chatbot-messages"></div>
    <div id="chatbot-input-area">
        <input type="text" id="chatbot-text" placeholder="Nh·∫≠p tin nh·∫Øn...">
        <button id="chatbot-send">G·ª≠i</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>
const toggleBtn = document.getElementById("chat-toggle-btn");
const chatBox = document.getElementById("chatbot-box");
const closeBtn = document.getElementById("chat-close");

// M·ªü chat
toggleBtn.addEventListener("click", () => {
    chatBox.style.display = "flex";
    toggleBtn.classList.add("hide");

    // N·∫øu l√† l·∫ßn ƒë·∫ßu m·ªü chat ‚Üí bot ch√†o tr∆∞·ªõc
    if (!window.chatStarted) {
        window.chatStarted = true;
        setTimeout(() => {
            addMessage("Chatbot", "Ch√†o b·∫°n üëã, m√¨nh l√† ng∆∞·ªùi b·∫°n ·∫£o lu√¥n l·∫Øng nghe b·∫°n. B·∫°n mu·ªën tr√≤ chuy·ªán v·ªÅ ƒëi·ªÅu g√¨?");
        }, 300);
    }
});

// ƒê√≥ng chat
closeBtn.addEventListener("click", () => {
    chatBox.style.display = "none";
    toggleBtn.classList.remove("hide");
});

// G·ª≠i tin nh·∫Øn
function sendMessage() {
    let text = document.getElementById("chatbot-text").value;
    if (text.trim() === "") return;

    addMessage("B·∫°n", text);
    document.getElementById("chatbot-text").value = "";

    fetch("/chatbot/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
    })
    .then(res => res.json())
    .then(data => {
        addMessage("Chatbot", data.reply || "Chatbot kh√¥ng tr·∫£ l·ªùi ƒë∆∞·ª£c.");
    })
    .catch(err => {
        addMessage("Chatbot", "‚ö†Ô∏è L·ªói k·∫øt n·ªëi server!");
    });
}

document.getElementById("chatbot-send").onclick = sendMessage;

function addMessage(sender, content) {
    let box = document.getElementById("chatbot-messages");
    box.innerHTML += `<p><strong>${sender}:</strong> ${content}</p>`;
    box.scrollTop = box.scrollHeight;
}
</script>
</body>
</html>
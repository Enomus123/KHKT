{% extends "app/base.html" %}

{% block content %}
<style>
    /* 1. L√†m n·ªïi b·∫≠t m·ª•c Nh·∫≠t k√Ω tr√™n Navbar (Th√™m v√†o n·∫øu ch∆∞a c√≥ trong base) */
    .nav-link[href*="history"] {
        color: #ffeb3b !important; /* M√†u v√†ng Gi√°ng sinh */
        font-weight: 8th !important;
        text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
    }

    /* 2. T·ªëi ∆∞u giao di·ªán tr√†n m√†n h√¨nh v√† d·ªÖ ƒë·ªçc */
    .history-container {
        max-width: 1000px;
        min-height: 100vh;
        padding-bottom: 120px;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.9) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        border-radius: 20px;
    }

    /* Ch·ªânh ch·ªØ ti√™u ƒë·ªÅ t·ª± co gi√£n theo thi·∫øt b·ªã */
    .responsive-title {
        color: #ffffff;
        text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.9), 0 0 20px rgba(212, 36, 38, 0.6);
        font-size: clamp(1.5rem, 6vw, 2.5rem);
    }

    /* M√†u ch·ªØ tin nh·∫Øn r√µ r√†ng tr√™n m·ªçi m√†n h√¨nh */
    .chat-text {
        color: #1a1a1a !important;
        font-weight: 500;
        line-height: 1.6;
        font-size: 1rem;
    }

    @media (max-width: 768px) {
        .glass-card {
            background: rgba(255, 255, 255, 0.98) !important; /* Tr√™n mobile √≠t trong su·ªët h∆°n ƒë·ªÉ d·ªÖ ƒë·ªçc */
            margin: 0 5px;
        }
    }
</style>

<div class="container-fluid py-4 history-container">
    <div class="d-flex justify-content-between align-items-center mb-4 px-2">
        <h2 class="fw-bold m-0 responsive-title">üìú Nh·∫≠t k√Ω tr√≤ chuy·ªán</h2>
        <button id="toggle-mood" class="btn btn-light btn-sm rounded-pill fw-bold shadow-lg px-3" onclick="toggleMood()">
            <i class="fas fa-chart-line text-danger"></i> Ph√¢n t√≠ch t√¢m tr·∫°ng
        </button>
    </div>

    <div id="mood-bubble-container" style="display: none;" class="mb-5 mx-2">
        <div class="card glass-card shadow-lg border-0" id="mood-card" style="border-left: 10px solid #ccc;">
            <div class="card-body p-4">
                <div id="mood-loading" class="text-center py-4">
                    <div class="spinner-grow text-danger" role="status"></div>
                    <p class="mt-2 text-dark fw-bold">Toco ƒëang l·∫Øng nghe tr√°i tim b·∫°n...</p>
                </div>
                
                <div id="mood-result" style="display: none;">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h3 class="fw-bold mb-0" id="mood-label">---</h3>
                            <div id="trend-badge" class="mt-1"></div>
                        </div>
                        <span id="mood-emoji" style="font-size: 2.5rem;">‚ú®</span>
                    </div>
                    
                    <p id="mood-summary" class="chat-text p-3 mb-3" style="background: rgba(0,0,0,0.05); border-radius: 15px;"></p>
                    
                    <div class="progress mb-2" style="height: 12px; background: #ddd; border-radius: 10px;">
                        <div id="mood-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between mb-4 small fw-bold text-white" style="text-shadow: 1px 1px 2px black;">
                        <span>R·∫•t ti√™u c·ª±c</span>
                        <span>T√≠ch c·ª±c</span>
                    </div>

                    <div id="advice-box" class="p-3 shadow-sm bg-white" style="border-radius: 20px; border: 2px dashed #d42426;">
                        <p class="mb-0 chat-text"><strong>üß∏ Toco nh·∫Øn nh·ªß:</strong> <span id="mood-advice"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="history-list px-2">
        {% if chats %}
            {% for c in chats %}
            <div class="card mb-3 border-0 shadow-sm glass-card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between small mb-2">
                        <span class="fw-bold {% if c.sender == 'user' %}text-success{% else %}text-danger{% endif %}">
                            {% if c.sender == 'user' %}B·∫°n{% else %}Toco{% endif %}
                        </span>
                        <span class="text-muted">{{ c.timestamp|date:"H:i - d/m/Y" }}</span>
                    </div>
                    <p class="mb-0 chat-text">{{ c.message }}</p>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center text-white mt-5">
                <p class="fs-5" style="text-shadow: 1px 1px 5px black;">H√£y b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán ƒë·ªÉ Toco l∆∞u l·∫°i k·ª∑ ni·ªám nhen! ‚ù§Ô∏è</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
    let isLoaded = false;
    function toggleMood() {
        const container = document.getElementById('mood-bubble-container');
        const btn = document.getElementById('toggle-mood');
        if (container.style.display === 'none') {
            container.style.display = 'block';
            btn.innerHTML = '<i class="fas fa-times"></i> ƒê√≥ng ph√¢n t√≠ch';
            if (!isLoaded) fetchMoodData();
        } else {
            container.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-chart-line"></i> Ph√¢n t√≠ch t√¢m tr·∫°ng';
        }
    }

    function fetchMoodData() {
        fetch('/mood-analysis/')
            .then(res => res.json())
            .then(data => {
                document.getElementById('mood-loading').style.display = 'none';
                document.getElementById('mood-result').style.display = 'block';
                
                const label = document.getElementById('mood-label');
                const bar = document.getElementById('mood-bar');
                const emoji = document.getElementById('mood-emoji');
                const trendBox = document.getElementById('trend-badge');
                const card = document.getElementById('mood-card');

                label.innerText = data.mood_label;
                document.getElementById('mood-summary').innerText = data.summary;
                document.getElementById('mood-advice').innerText = data.advice;

                // C·∫≠p nh·∫≠t xu h∆∞·ªõng (Trend)
                if (data.trend === 'up') trendBox.innerHTML = '<span class="badge bg-success shadow-sm">üìà ƒêang t·ªët l√™n</span>';
                else if (data.trend === 'down') trendBox.innerHTML = '<span class="badge bg-danger shadow-sm">üìâ C·∫ßn ch√∫ √Ω</span>';
                else trendBox.innerHTML = '<span class="badge bg-info shadow-sm">üìä ·ªîn ƒë·ªãnh</span>';

                // M√†u s·∫Øc & Emoji theo ƒëi·ªÉm s·ªë
                let color, emo;
                if (data.score <= 20) { color = "#212529"; emo = "üñ§"; bar.className = "progress-bar bg-dark"; }
                else if (data.score <= 40) { color = "#6c757d"; emo = "‚òÅÔ∏è"; bar.className = "progress-bar bg-secondary"; }
                else if (data.score <= 60) { color = "#0dcaf0"; emo = "üòê"; bar.className = "progress-bar bg-info"; }
                else if (data.score <= 80) { color = "#ffc107"; emo = "üå§Ô∏è"; bar.className = "progress-bar bg-warning text-dark"; }
                else { color = "#198754"; emo = "üåü"; bar.className = "progress-bar bg-success"; }

                label.style.color = color;
                emoji.innerText = emo;
                card.style.borderLeftColor = color;
                
                setTimeout(() => { bar.style.width = data.score + '%'; }, 300);
                isLoaded = true;
            })
            .catch(err => {
                document.getElementById('mood-loading').innerHTML = "<p class='text-danger'>Toco ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch t√¢m tr·∫°ng l√∫c n√†y...</p>";
            });
    }
</script>
{% endblock %}